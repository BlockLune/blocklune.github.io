<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="google7b9c7ea42a3102a3.html">
  <meta name="baidu-site-verification" content="baidu_verify_code-53bseLro2G.html">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fishg.top","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="This is a note for Nand2Tetris Unit 6.">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes for Nand2Tetris: Assembler">
<meta property="og:url" content="https://fishg.top/posts/869cdee6.html">
<meta property="og:site_name" content="Fish Pond">
<meta property="og:description" content="This is a note for Nand2Tetris Unit 6.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-07-17T12:28:42.000Z">
<meta property="article:modified_time" content="2023-12-06T08:08:12.454Z">
<meta property="article:author" content="BlockLune">
<meta property="article:tag" content="Coursera">
<meta property="article:tag" content="Nand2Tetris">
<meta property="article:tag" content="Assembler">
<meta property="article:tag" content="Assembly Language">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fishg.top/posts/869cdee6.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://fishg.top/posts/869cdee6.html","path":"posts/869cdee6.html","title":"Notes for Nand2Tetris: Assembler"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Notes for Nand2Tetris: Assembler | Fish Pond</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XQDPHGPHDL"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-XQDPHGPHDL","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>






  <script async defer data-website-id="f576c93d-b2e8-4701-9cd1-797cb6a6b79a" src="https://analytics.umami.is/script.js"></script>


  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss.xml" title="Fish Pond" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Fish Pond</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Posts swim here.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Unit-6-1"><span class="nav-number">1.</span> <span class="nav-text">Unit 6.1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Basic-Assembler-Logic"><span class="nav-number">1.1.</span> <span class="nav-text">Basic Assembler Logic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Symbols"><span class="nav-number">1.2.</span> <span class="nav-text">Symbols</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Allocation-of-variables"><span class="nav-number">1.2.1.</span> <span class="nav-text">Allocation of variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Labels"><span class="nav-number">1.2.2.</span> <span class="nav-text">Labels</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Forward-references"><span class="nav-number">1.2.3.</span> <span class="nav-text">Forward references</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unit-6-2"><span class="nav-number">2.</span> <span class="nav-text">Unit 6.2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unit-6-3"><span class="nav-number">3.</span> <span class="nav-text">Unit 6.3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Translating-A-instruction"><span class="nav-number">3.1.</span> <span class="nav-text">Translating A-instruction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Translating-C-instruction"><span class="nav-number">3.2.</span> <span class="nav-text">Translating C-instruction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-overall-assembly-logic"><span class="nav-number">3.3.</span> <span class="nav-text">The overall assembly logic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unit-6-4"><span class="nav-number">4.</span> <span class="nav-text">Unit 6.4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Handling-symbols"><span class="nav-number">4.1.</span> <span class="nav-text">Handling symbols</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Symbol-table"><span class="nav-number">4.2.</span> <span class="nav-text">Symbol table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-assembly-process"><span class="nav-number">4.3.</span> <span class="nav-text">The assembly process</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-6"><span class="nav-number">5.</span> <span class="nav-text">Project 6</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="BlockLune"
      src="/img/waifu.png">
  <p class="site-author-name" itemprop="name">BlockLune</p>
  <div class="site-description" itemprop="description">Here is BlockLune's blog.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">73</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">111</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/BlockLune" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;BlockLune" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blocklune@gmail.com" title="E-Mail → mailto:blocklune@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://f-studio.is-best.net/" title="http:&#x2F;&#x2F;f-studio.is-best.net&#x2F;" rel="noopener" target="_blank">F-Studio</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://luoyuxuanryan.github.io/" title="https:&#x2F;&#x2F;luoyuxuanryan.github.io&#x2F;" rel="noopener" target="_blank">Radish Garden</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://tommygong.top/" title="https:&#x2F;&#x2F;tommygong.top&#x2F;" rel="noopener" target="_blank">TommyGong's Blog</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.yfi.moe/" title="http:&#x2F;&#x2F;blog.yfi.moe&#x2F;" rel="noopener" target="_blank">Yunfi's Blog</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://fishg.top/posts/869cdee6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/img/waifu.png">
      <meta itemprop="name" content="BlockLune">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fish Pond">
      <meta itemprop="description" content="Here is BlockLune's blog.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Notes for Nand2Tetris: Assembler | Fish Pond">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Notes for Nand2Tetris: Assembler
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-17 20:28:42" itemprop="dateCreated datePublished" datetime="2023-07-17T20:28:42+08:00">2023-07-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/" itemprop="url" rel="index"><span itemprop="name">CS</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/computing-system/" itemprop="url" rel="index"><span itemprop="name">Computing System</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/computing-system/nand2tetris/" itemprop="url" rel="index"><span itemprop="name">Nand2Tetris</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>This is a note for Nand2Tetris Unit 6.</p>
<span id="more"></span>

<h2 id="Unit-6-1"><a href="#Unit-6-1" class="headerlink" title="Unit 6.1"></a>Unit 6.1</h2><p>Cross compiler: It’s running on one computer and producing code intended for another computer.</p>
<h3 id="Basic-Assembler-Logic"><a href="#Basic-Assembler-Logic" class="headerlink" title="Basic Assembler Logic"></a>Basic Assembler Logic</h3><p>Repeat:</p>
<ul>
<li>Read the next Assembly language command</li>
<li>Break it into the different fields it is composed of</li>
<li>Lookup the binary code for each field</li>
<li>Combine these codes into a single machine language command</li>
<li>Output this machine language command</li>
</ul>
<p>Until end-of-file reached</p>
<h3 id="Symbols"><a href="#Symbols" class="headerlink" title="Symbols"></a>Symbols</h3><p>Symbols are used for labels and variables.</p>
<p>Assembler must replace names with addresses.</p>
<p>Introducing… <strong>Symbol table</strong>.</p>
<h4 id="Allocation-of-variables"><a href="#Allocation-of-variables" class="headerlink" title="Allocation of variables"></a>Allocation of variables</h4><p>First we look at the table. If the variable has already been in the table, we can just read its address. But if the variable is not there, we must allocate memory to it and record its address.</p>
<h4 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h4><p>…</p>
<h4 id="Forward-references"><a href="#Forward-references" class="headerlink" title="Forward references"></a>Forward references</h4><p>Sometimes we can jump into a label before the label was actually defined.</p>
<p>Possible solutions:</p>
<ul>
<li>Leave blank until label appears, then fix</li>
<li>In first pass just figure out all addresses</li>
</ul>
<h2 id="Unit-6-2"><a href="#Unit-6-2" class="headerlink" title="Unit 6.2"></a>Unit 6.2</h2><p>Assembly program elements:</p>
<ul>
<li>White space<ul>
<li>Empty lines / indentation</li>
<li>Line comments</li>
<li>In-line comments</li>
</ul>
</li>
<li>Instructions<ul>
<li>A-instruction</li>
<li>C-instruction</li>
</ul>
</li>
<li>Symbols<ul>
<li>References</li>
<li>Label declarations</li>
</ul>
</li>
</ul>
<h2 id="Unit-6-3"><a href="#Unit-6-3" class="headerlink" title="Unit 6.3"></a>Unit 6.3</h2><h3 id="Translating-A-instruction"><a href="#Translating-A-instruction" class="headerlink" title="Translating A-instruction"></a>Translating A-instruction</h3><p>Translation to binary:</p>
<ul>
<li>If $value$ is a decimal constant, generate the equivalent 15-bit binary constant</li>
<li>If $value$ is a symbol, later</li>
</ul>
<h3 id="Translating-C-instruction"><a href="#Translating-C-instruction" class="headerlink" title="Translating C-instruction"></a>Translating C-instruction</h3><p>…</p>
<h3 id="The-overall-assembly-logic"><a href="#The-overall-assembly-logic" class="headerlink" title="The overall assembly logic"></a>The overall assembly logic</h3><p>For each instruction</p>
<ul>
<li>Parse the instruction: break it into its underlying fields</li>
<li>A-instruction: translate the decimal value into a binary value</li>
<li>C-instruction: for each field in the instruction, generate the corresponding binary code; assemble the translated binary codes into a complete 16-bit machine instruction</li>
<li>Write the 16-bit instruction to the output file</li>
</ul>
<h2 id="Unit-6-4"><a href="#Unit-6-4" class="headerlink" title="Unit 6.4"></a>Unit 6.4</h2><h3 id="Handling-symbols"><a href="#Handling-symbols" class="headerlink" title="Handling symbols"></a>Handling symbols</h3><p>Symbols:</p>
<ul>
<li><strong>variable symbols</strong>: represent memory locations where the programmer wants to maintain values</li>
<li><strong>label symbols</strong>: represent destinations of goto instructions</li>
<li><strong>pre-defined symbols</strong>: represent special memory locations</li>
</ul>
<p>The Hack language specification describes 23 pre-defined symbols: …</p>
<p>Translating @$preDefinedSymbol$:</p>
<p>Replace $preDefinedSymbol$ with its value</p>
<p>Translating @$label$:</p>
<p>…</p>
<p>Variable symbols:</p>
<ul>
<li>Any symbol XXX appearing in an assembly program which is not pre-defined and is not defined elsewhere using the (XXX) directive is treated as a $variable$</li>
<li>Each variable is assigned a unique memory address, starting at 16 (specified by the Hack language)</li>
</ul>
<p>Translating @$variableSymbol$:</p>
<ul>
<li>If you see it for the first time, assign a unique memory address</li>
<li>Replace $variableSymbol$ with its value</li>
</ul>
<h3 id="Symbol-table"><a href="#Symbol-table" class="headerlink" title="Symbol table"></a>Symbol table</h3><ul>
<li>Initialization: Add the pre-defined symbols</li>
<li>First pass: Add the label symbols</li>
<li>Second pass: Add var. symbols</li>
</ul>
<p>To resolve a symbol, look up its value in the symbol table.</p>
<h3 id="The-assembly-process"><a href="#The-assembly-process" class="headerlink" title="The assembly process"></a>The assembly process</h3><ul>
<li>Initialization<ul>
<li>Construct an empty symbol table</li>
<li>Add the pre-defined symbols to the symbol table</li>
</ul>
</li>
<li>First pass<br>Scan the program;<br>For each “instruction” of the form (XXX):<ul>
<li>Add the pair (XXX, $address$) to the symbol table, where $address$ is the number of the instruction following (XXX)</li>
</ul>
</li>
<li>Second pass<br>Set $n$ to 16<br>Scan the entire program again; for each instruction:<ul>
<li>If the instruction is @$symbol$, look up $symbol$ in the symbol table;<ul>
<li>If ($symbol$, $value$) is found, use $value$ to complete the instruction’s translation;</li>
<li>If not found:<ul>
<li>Add ($symbol$, $n$) to the symbol table</li>
<li>Use $n$ to complete the instruction’s translation</li>
<li>$n$++</li>
</ul>
</li>
</ul>
</li>
<li>If the instruction is a C-instruction, complete the instruction’s translation</li>
<li>Write the translated instruction to the output file</li>
</ul>
</li>
</ul>
<h2 id="Project-6"><a href="#Project-6" class="headerlink" title="Project 6"></a>Project 6</h2><p>My assembler for Hack computer written in Python:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">symbol_table = {</span><br><span class="line">    <span class="string">"R0"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"R1"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"R2"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"R3"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"R4"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">"R5"</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="string">"R6"</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">"R7"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="string">"R8"</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">"R9"</span>: <span class="number">9</span>,</span><br><span class="line">    <span class="string">"R10"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="string">"R11"</span>: <span class="number">11</span>,</span><br><span class="line">    <span class="string">"R12"</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="string">"R13"</span>: <span class="number">13</span>,</span><br><span class="line">    <span class="string">"R14"</span>: <span class="number">14</span>,</span><br><span class="line">    <span class="string">"R15"</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="string">"SCREEN"</span>: <span class="number">16384</span>,</span><br><span class="line">    <span class="string">"KBD"</span>: <span class="number">24576</span>,</span><br><span class="line">    <span class="string">"SP"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"LCL"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"ARG"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"THIS"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">"THAT"</span>: <span class="number">4</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    filename = get_filename()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filename.endswith(<span class="string">".asm"</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"Invalid file"</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename[:-<span class="number">4</span>] + <span class="string">".hack"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> file:</span><br><span class="line">        lines = (line + <span class="string">"\n"</span> <span class="keyword">for</span> line <span class="keyword">in</span> second_pass(first_pass(filename)))</span><br><span class="line">        file.writelines(lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_filename</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        prog=<span class="string">"assembler.py"</span>,</span><br><span class="line">        description=<span class="string">"An assembler for Hack computer."</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(<span class="string">"filename"</span>, <span class="built_in">help</span>=<span class="string">"the asm file to be processed"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args.filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">first_pass</span>(<span class="params">filename: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="keyword">global</span> symbol_table</span><br><span class="line">    instructions = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">            <span class="keyword">if</span> re.search(<span class="string">r"^//"</span>, line.strip()):</span><br><span class="line">                <span class="comment"># comments</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> line.strip() == <span class="string">""</span>:</span><br><span class="line">                <span class="comment"># blank line</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="keyword">match</span> := re.search(<span class="string">r"^\((.+)\)"</span>, line.strip()):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                    label = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                    symbol_table[label] = <span class="built_in">len</span>(instructions)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                instruction = re.sub(<span class="string">r"//.*"</span>, <span class="string">""</span>, line).strip()</span><br><span class="line">                instructions.append(instruction)</span><br><span class="line">    <span class="keyword">return</span> instructions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">second_pass</span>(<span class="params">instructions: <span class="built_in">list</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">    <span class="keyword">global</span> symbol_table</span><br><span class="line">    binary_instructions = []</span><br><span class="line">    n = <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> instruction <span class="keyword">in</span> instructions:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span> := re.search(<span class="string">r"^@(.*)$"</span>, instruction):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                value = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> value.isdigit():</span><br><span class="line">                    binary_instructions.append(</span><br><span class="line">                        <span class="string">"0"</span> + <span class="built_in">str</span>(<span class="built_in">bin</span>(<span class="built_in">int</span>(value))[<span class="number">2</span>:]).zfill(<span class="number">15</span>))</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    symbol = value</span><br><span class="line">                <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> symbol_table:</span><br><span class="line">                    symbol_table[symbol] = n</span><br><span class="line">                    n = n + <span class="number">1</span></span><br><span class="line">                binary_instructions.append(</span><br><span class="line">                    <span class="string">"0"</span> + <span class="built_in">str</span>(<span class="built_in">bin</span>(symbol_table[symbol])[<span class="number">2</span>:]).zfill(<span class="number">15</span>)</span><br><span class="line">                )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            binary_instructions.append(parse_c_instruction(instruction))</span><br><span class="line">    <span class="keyword">return</span> binary_instructions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_c_instruction</span>(<span class="params">instruction: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    cccccc = {</span><br><span class="line">        <span class="string">"0"</span>: <span class="string">"101010"</span>,</span><br><span class="line">        <span class="string">"1"</span>: <span class="string">"111111"</span>,</span><br><span class="line">        <span class="string">"-1"</span>: <span class="string">"111010"</span>,</span><br><span class="line">        <span class="string">"D"</span>: <span class="string">"001100"</span>,</span><br><span class="line">        <span class="string">"A"</span>: <span class="string">"110000"</span>,</span><br><span class="line">        <span class="string">"M"</span>: <span class="string">"110000"</span>,</span><br><span class="line">        <span class="string">"!D"</span>: <span class="string">"001101"</span>,</span><br><span class="line">        <span class="string">"!A"</span>: <span class="string">"110001"</span>,</span><br><span class="line">        <span class="string">"!M"</span>: <span class="string">"110001"</span>,</span><br><span class="line">        <span class="string">"-D"</span>: <span class="string">"001111"</span>,</span><br><span class="line">        <span class="string">"-A"</span>: <span class="string">"110011"</span>,</span><br><span class="line">        <span class="string">"-M"</span>: <span class="string">"110011"</span>,</span><br><span class="line">        <span class="string">"D+1"</span>: <span class="string">"011111"</span>,</span><br><span class="line">        <span class="string">"A+1"</span>: <span class="string">"110111"</span>,</span><br><span class="line">        <span class="string">"M+1"</span>: <span class="string">"110111"</span>,</span><br><span class="line">        <span class="string">"D-1"</span>: <span class="string">"001110"</span>,</span><br><span class="line">        <span class="string">"A-1"</span>: <span class="string">"110010"</span>,</span><br><span class="line">        <span class="string">"M-1"</span>: <span class="string">"110010"</span>,</span><br><span class="line">        <span class="string">"D+A"</span>: <span class="string">"000010"</span>,</span><br><span class="line">        <span class="string">"D+M"</span>: <span class="string">"000010"</span>,</span><br><span class="line">        <span class="string">"D-A"</span>: <span class="string">"010011"</span>,</span><br><span class="line">        <span class="string">"D-M"</span>: <span class="string">"010011"</span>,</span><br><span class="line">        <span class="string">"A-D"</span>: <span class="string">"000111"</span>,</span><br><span class="line">        <span class="string">"M-D"</span>: <span class="string">"000111"</span>,</span><br><span class="line">        <span class="string">"D&amp;A"</span>: <span class="string">"000000"</span>,</span><br><span class="line">        <span class="string">"D&amp;M"</span>: <span class="string">"000000"</span>,</span><br><span class="line">        <span class="string">"D|A"</span>: <span class="string">"010101"</span>,</span><br><span class="line">        <span class="string">"D|M"</span>: <span class="string">"010101"</span>,</span><br><span class="line">    }</span><br><span class="line">    jjj = {</span><br><span class="line">        <span class="literal">None</span>: <span class="string">"000"</span>,</span><br><span class="line">        <span class="string">"JGT"</span>: <span class="string">"001"</span>,</span><br><span class="line">        <span class="string">"JEQ"</span>: <span class="string">"010"</span>,</span><br><span class="line">        <span class="string">"JGE"</span>: <span class="string">"011"</span>,</span><br><span class="line">        <span class="string">"JLT"</span>: <span class="string">"100"</span>,</span><br><span class="line">        <span class="string">"JNE"</span>: <span class="string">"101"</span>,</span><br><span class="line">        <span class="string">"JLE"</span>: <span class="string">"110"</span>,</span><br><span class="line">        <span class="string">"JMP"</span>: <span class="string">"111"</span>,</span><br><span class="line">    }</span><br><span class="line">    binary_instruction = <span class="string">"111"</span></span><br><span class="line">    <span class="keyword">match</span> = re.search(</span><br><span class="line">        <span class="string">r"^(?:((?:A|D|M){1,3})=)?((?:0|1|\+|-|!|&amp;|\||D|A|M)+)(?:;(JGT|JEQ|JGE|JLT|JNE|JLE|JMP))?$"</span>,</span><br><span class="line">        instruction,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        dest = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">        comp = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">        jump = <span class="keyword">match</span>.group(<span class="number">3</span>)</span><br><span class="line">        <span class="comment"># a</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"M"</span> <span class="keyword">in</span> comp:</span><br><span class="line">            binary_instruction += <span class="string">"1"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            binary_instruction += <span class="string">"0"</span></span><br><span class="line">        <span class="comment"># cccccc</span></span><br><span class="line">        binary_instruction += cccccc[comp]</span><br><span class="line">        <span class="comment"># ddd</span></span><br><span class="line">        binary_instruction += get_ddd(dest)</span><br><span class="line">        <span class="comment"># jjj</span></span><br><span class="line">        binary_instruction += jjj[jump]</span><br><span class="line">        <span class="keyword">return</span> binary_instruction</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"Invalid C-instruction"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ddd</span>(<span class="params">dest: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">if</span> dest == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"000"</span></span><br><span class="line">    d = [<span class="string">"0"</span>, <span class="string">"0"</span>, <span class="string">"0"</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"M"</span> <span class="keyword">in</span> dest:</span><br><span class="line">        d[<span class="number">2</span>] = <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"D"</span> <span class="keyword">in</span> dest:</span><br><span class="line">        d[<span class="number">1</span>] = <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">"A"</span> <span class="keyword">in</span> dest:</span><br><span class="line">        d[<span class="number">0</span>] = <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">return</span> d[<span class="number">0</span>] + d[<span class="number">1</span>] + d[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/rss.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/coursera/" rel="tag"># Coursera</a>
              <a href="/tags/nand2tetris/" rel="tag"># Nand2Tetris</a>
              <a href="/tags/assembler/" rel="tag"># Assembler</a>
              <a href="/tags/assembly-language/" rel="tag"># Assembly Language</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/a6f57fef.html" rel="prev" title="Notes for Machine Learning">
                  <i class="fa fa-chevron-left"></i> Notes for Machine Learning
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/d8b14680.html" rel="next" title="Notes for Nand2Tetris: Virtual Machine I: Stack Arithmetic">
                  Notes for Nand2Tetris: Virtual Machine I: Stack Arithmetic <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">BlockLune</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/BlockLune" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.3/mermaid.min.js","integrity":"sha256-JFptYy4KzJ5OQP+Q9fubNf3cxpPPmZKqUOovyEONKrQ="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"BlockLune","repo":"blocklune.github.io","client_id":"f0d9ff2c460a605d4f3f","client_secret":"9808616eda1afe0741c036b5d5670a490b68f6ef","admin_user":"BlockLune","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"f0246ed5d6d62b23679f060436db1bed"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
